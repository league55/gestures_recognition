const PORT = 3300
const express = require('express')
const cors = require('cors')
const bodyParser = require('body-parser')
const {readData} = require("./public/javascripts/process");
const {getData} = require("./public/javascripts/process");
const {predict} = require("./public/javascripts/ml");
const {trainModel} = require("./public/javascripts/ml");
const {prepareData} = require("./public/javascripts/process");
const {appendLines} = require("./public/javascripts/csv");
const app = express();

app.use(bodyParser.json()) // note: this is before the route
app.use(cors())

app.post('/raws', (req, res) => {
  console.log(req.body);
  const lines = req.body.data.map(line => line.join(',') + req.body.label).join('\n');
  appendLines(lines);
  res.sendStatus(200);
})

app.post('/raw', (req, res) => {
  console.log(req.body);
  appendLines(req.body.data.map(JSON.stringify).join(',')  + "," + req.body.label + "\n");
  res.sendStatus(200);
})

app.get('/data', (req, res) => {
  res.send(readData('data.csv'));
})

app.post('/pattern', (req, res) => {
  console.log(req.body);
  appendLines(req.body.data.map(JSON.stringify).join(',')  + "," + req.body.label + "\n", "pattern.csv");
  res.sendStatus(200);
})

app.use(express.json())

// console.log(`Listen on port ${PORT}`)
// const preparedData = prepareData('data.csv');
// trainModel(preparedData).then(model => {
//   const pred1 = predict(model, getData("{\"x\":0.33689719438552856,\"y\":0.5852652192115784,\"z\":0.000030447574317804538},{\"x\":0.3745150864124298,\"y\":0.6147379875183105,\"z\":0.018265407532453537},{\"x\":0.4084920287132263,\"y\":0.6197784543037415,\"z\":0.02064727060496807},{\"x\":0.4387998580932617,\"y\":0.6285526752471924,\"z\":0.013635494746267796},{\"x\":0.4661104679107666,\"y\":0.6200218796730042,\"z\":0.0016341852024197578},{\"x\":0.4220336675643921,\"y\":0.5067611336708069,\"z\":0.042284753173589706},{\"x\":0.45524072647094727,\"y\":0.5280289053916931,\"z\":0.020018352195620537},{\"x\":0.4679368734359741,\"y\":0.5750227570533752,\"z\":-0.006272461730986834},{\"x\":0.46878600120544434,\"y\":0.6164677143096924,\"z\":-0.017248431220650673},{\"x\":0.4233826696872711,\"y\":0.47665053606033325,\"z\":0.019242238253355026},{\"x\":0.4645845592021942,\"y\":0.43351179361343384,\"z\":0.01672656275331974},{\"x\":0.4973207712173462,\"y\":0.4289871156215668,\"z\":0.008497094735503197},{\"x\":0.5261200666427612,\"y\":0.43900495767593384,\"z\":0.003970886114984751},{\"x\":0.4144246280193329,\"y\":0.459661602973938,\"z\":-0.007741054054349661},{\"x\":0.4500886797904968,\"y\":0.4048735201358795,\"z\":-0.009333423338830471},{\"x\":0.48237764835357666,\"y\":0.3851681351661682,\"z\":-0.013836213387548923},{\"x\":0.5119087100028992,\"y\":0.38281047344207764,\"z\":-0.01678008772432804},{\"x\":0.4002639353275299,\"y\":0.4554755687713623,\"z\":-0.03618290275335312},{\"x\":0.42520567774772644,\"y\":0.40086668729782104,\"z\":-0.03896620497107506},{\"x\":0.4482009708881378,\"y\":0.3743111491203308,\"z\":-0.0421241819858551},{\"x\":0.47185009717941284,\"y\":0.36190158128738403,\"z\":-0.0450412891805172},ok"));
//   console.log("pred1", pred1);
//   const pred2 = predict(model, getData("{\"x\":0.2938157618045807,\"y\":0.7193742990493774,\"z\":-0.00002746129030128941},{\"x\":0.33587846159935,\"y\":0.7149682641029358,\"z\":0.00003034410474356264},{\"x\":0.36948996782302856,\"y\":0.6907485723495483,\"z\":-0.010643747635185719},{\"x\":0.3951498866081238,\"y\":0.6781303286552429,\"z\":-0.02763684093952179},{\"x\":0.40849053859710693,\"y\":0.6467100381851196,\"z\":-0.0464685820043087},{\"x\":0.35438272356987,\"y\":0.5846646428108215,\"z\":0.003588208695873618},{\"x\":0.3873513340950012,\"y\":0.5737038254737854,\"z\":-0.028629327192902565},{\"x\":0.40628018975257874,\"y\":0.6101403832435608,\"z\":-0.05079478770494461},{\"x\":0.41362133622169495,\"y\":0.6473461389541626,\"z\":-0.0573604479432106},{\"x\":0.34524527192115784,\"y\":0.5640581846237183,\"z\":-0.015370766632258892},{\"x\":0.3695064187049866,\"y\":0.49345675110816956,\"z\":-0.03677278012037277},{\"x\":0.39692017436027527,\"y\":0.4700656533241272,\"z\":-0.05705506354570389},{\"x\":0.42140820622444153,\"y\":0.45832687616348267,\"z\":-0.06983011215925217},{\"x\":0.32875561714172363,\"y\":0.5627721548080444,\"z\":-0.037561677396297455},{\"x\":0.3420644998550415,\"y\":0.48570263385772705,\"z\":-0.060108862817287445},{\"x\":0.3632606267929077,\"y\":0.44837674498558044,\"z\":-0.08021301031112671},{\"x\":0.3851351737976074,\"y\":0.42291563749313354,\"z\":-0.09242819249629974},{\"x\":0.310504674911499,\"y\":0.5782804489135742,\"z\":-0.06046513840556145},{\"x\":0.31369084119796753,\"y\":0.5158703327178955,\"z\":-0.07980583608150482},{\"x\":0.3249027729034424,\"y\":0.48168161511421204,\"z\":-0.09161384403705597},{\"x\":0.339711457490921,\"y\":0.4537268877029419,\"z\":-0.10179316252470016},ok"));
//   console.log("pred2", pred2);
//   const pred3 = predict(model, getData("{\"x\":0.31221407651901245,\"y\":0.7225366830825806,\"z\":-0.000023696966309216805},{\"x\":0.2948853075504303,\"y\":0.6367552280426025,\"z\":-0.006561413407325745},{\"x\":0.3036336898803711,\"y\":0.5664532780647278,\"z\":-0.016658471897244453},{\"x\":0.3122306168079376,\"y\":0.5058541893959045,\"z\":-0.022449485957622528},{\"x\":0.31689023971557617,\"y\":0.45561671257019043,\"z\":-0.026468956843018532},{\"x\":0.3830486536026001,\"y\":0.5643635392189026,\"z\":-0.03063729777932167},{\"x\":0.43425431847572327,\"y\":0.49906018376350403,\"z\":-0.030473539605736732},{\"x\":0.4637720584869385,\"y\":0.4698364734649658,\"z\":-0.03042888082563877},{\"x\":0.48583492636680603,\"y\":0.4508097171783447,\"z\":-0.025858592242002487},{\"x\":0.4020921289920807,\"y\":0.6074323058128357,\"z\":-0.010912117548286915},{\"x\":0.45977282524108887,\"y\":0.5458487868309021,\"z\":-0.006326944567263126},{\"x\":0.4895656108856201,\"y\":0.5144565105438232,\"z\":0.0040343571454286575},{\"x\":0.510522723197937,\"y\":0.4916791617870331,\"z\":0.012594340369105339},{\"x\":0.40963631868362427,\"y\":0.6432393193244934,\"z\":0.013368461281061172},{\"x\":0.45612484216690063,\"y\":0.5871118903160095,\"z\":0.03269169107079506},{\"x\":0.477473646402359,\"y\":0.555172860622406,\"z\":0.05076441913843155},{\"x\":0.4913601577281952,\"y\":0.5307603478431702,\"z\":0.062346450984478},{\"x\":0.4094024896621704,\"y\":0.6690824031829834,\"z\":0.03742573410272598},{\"x\":0.44180062413215637,\"y\":0.6144182085990906,\"z\":0.061036404222249985},{\"x\":0.4519089460372925,\"y\":0.5874065160751343,\"z\":0.07997257262468338},{\"x\":0.4559616446495056,\"y\":0.5679494142532349,\"z\":0.09348990768194199},"));
//   console.log("pred3", pred3);
// });



app.listen(PORT)
